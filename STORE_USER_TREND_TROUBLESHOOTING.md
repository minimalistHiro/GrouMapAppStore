# 店舗利用者推移データ取得の問題解決ガイド

## 問題の概要

`store_user_trend_view.dart` で以下の問題が発生していました：
1. データが取得できない
2. ローディングインジケーターが永久に回転する
3. データが0の場合の表示が不明確

## 原因

1. **複雑なストリーム管理**: 以前の実装では、全ユーザーを監視してから各ユーザーのサブコレクションを個別に監視する複雑な構造になっており、初回データ取得時に問題が発生していました。

2. **永続的なStream.periodic**: 2秒ごとにデータを取得し続けるため、パフォーマンスとローディング状態の管理に問題がありました。

3. **データ構造**: Firestoreのデータ構造は以下のようになっています：
   ```
   point_transactions/{storeId}/{userId}/{transactionId}
   ```

4. **UIフィードバック不足**: データがない場合や読み込み中の状態表示が不十分でした。

## 実施した修正

### 1. `store_provider.dart` の `storeUserTrendProvider` を改善

**変更前**: `StreamProvider` + `Stream.periodic`（永続的に2秒ごとに取得）
**変更後**: `FutureProvider`（一度だけデータを取得）

主な改善点：
- 一度だけデータを取得し、必要に応じて手動で再読み込み
- ローディング状態が適切に管理される
- パフォーマンスの向上（不要な繰り返し取得がない）
- より詳細なデバッグログを維持

### 2. `sample_data_creator.dart` に診断機能を追加

追加した機能：
- `createSamplePointTransactions()`: サンプルのポイントトランザクションデータを作成
- `diagnosePointTransactions()`: 現在のデータ状況を診断してコンソールに出力

### 3. `store_user_trend_view.dart` の UI/UX を改善

**追加機能**:
- **デバッグメニュー**: 右上のバグアイコン (🐛) から診断・サンプルデータ作成にアクセス
  - データ診断: 現在のポイントトランザクションデータを確認
  - サンプルデータ作成: テスト用のポイントトランザクションデータを作成

**表示の改善**:
- **データが0の場合**: 期間に応じたメッセージと代替提案を表示
  - 例: "過去7日間にポイント付与の履歴がありません"
  - "別の期間を選択してみてください" という案内
- **エラー時**: より詳細なエラーメッセージと再試行ボタン
- **リフレッシュボタン**: データ更新時にフィードバックメッセージを表示
- **期間選択**: 期間変更時に自動でデータを再読み込み

## 使用方法

### 1. データ診断を実行

1. アプリで「店舗利用者推移」画面を開く
2. 右上のバグアイコンをタップ
3. 「データ診断」を選択
4. Flutterのコンソール（ターミナル）でログを確認

診断結果の例：
```
=== Point Transactions 診断開始 ===
StoreId: your_store_id
総ユーザー数: 5

--- User: user_id_1 ---
トランザクション数: 7
  - ポイント付与: 10ポイント (Timestamp(...))
  - ポイント付与: 15ポイント (Timestamp(...))
  ...

=== 診断結果 ===
総トランザクション数: 35
ポイント付与: 30
ポイント支払い: 5
=== Point Transactions 診断完了 ===
```

### 2. サンプルデータを作成（データがない場合）

1. アプリで「店舗利用者推移」画面を開く
2. 右上のバグアイコンをタップ
3. 「サンプルデータ作成」を選択
4. 完了のメッセージが表示されるのを待つ
5. リフレッシュボタンをタップしてデータを更新

サンプルデータの内容：
- 過去1週間分のポイント付与トランザクション（6件）
- ポイント支払いトランザクション（1件）

### 3. コンソールログでデータ取得を確認

修正後の`storeUserTrendProvider`は詳細なログを出力します：

```
=== StoreUserTrendProvider START ===
StoreId: your_store_id, Period: week
Date Range: 2025-10-01... to 2025-10-08...
--- Fetching user trend data ---
Found 5 users
User user_id_1: 7 transactions
User user_id_2: 0 transactions
Total transactions: 7
Point award transactions: 6
Filtered transactions in date range: 6
Daily users: 6 days
Result: 6 data points
Sample data: [{date: 2025-10-02, userCount: 1}, {date: 2025-10-03, userCount: 1}, ...]
=== StoreUserTrendProvider END ===
```

## よくある問題と解決方法

### 問題1: グラフにデータが表示されない

**確認事項**:
1. データ診断を実行してトランザクションが存在するか確認
2. トランザクションの日付が選択した期間内にあるか確認
3. `description`フィールドが「ポイント付与」になっているか確認

**解決方法**:
- データがない場合: サンプルデータ作成機能を使用
- 期間外の場合: 期間選択を変更（週→月→年）
- description不一致: Firestoreで直接データを修正

### 問題2: 「店舗情報が見つかりません」と表示される

**確認事項**:
1. ユーザーがログインしているか確認
2. ユーザーに`createdStores`または`currentStoreId`が設定されているか確認

**解決方法**:
- Firebase Consoleでusersコレクションを確認
- 必要に応じてユーザードキュメントに店舗IDを追加

### 問題3: コンソールログに何も表示されない

**確認事項**:
1. Flutterアプリがデバッグモードで実行されているか確認
2. ターミナル/コンソールが正しいプロセスを表示しているか確認

**解決方法**:
```bash
# ターミナルでFlutterアプリを起動
flutter run
```

## データ構造の詳細

### point_transactions コレクション

```
point_transactions/
  {storeId}/              # 店舗ID
    {userId}/             # ユーザーID
      {transactionId}     # トランザクションID
        - storeId: string
        - userId: string
        - storeName: string
        - userName: string
        - amount: number
        - description: string  # "ポイント付与" または "ポイント支払い"
        - createdAt: Timestamp
```

### 必須フィールド

- `description`: "ポイント付与"（利用者推移では、このタイプのみをカウント）
- `createdAt`: Timestamp型の日時
- `userId`: ユーザーを識別するID

## パフォーマンスに関する注意

現在の実装は`FutureProvider`を使用し、一度だけデータを取得します。大量のユーザーがいる場合、以下の最適化を検討してください：

1. **キャッシュの活用**: Firestoreのキャッシュ機能を活用（デフォルトで有効）
2. **インデックスの作成**: Firestoreで複合インデックスを作成
3. **ページング**: 大量のユーザーがいる場合はページング処理を検討
4. **バックグラウンド集計**: Cloud Functionsで日次/週次集計を事前に計算

## 今後の改善案

1. **リアルタイム更新**: Firestoreの`snapshots()`を使用してリアルタイムでデータを更新
2. **集計の事前計算**: Cloud Functionsで日次/週次/月次集計を事前に計算してパフォーマンスを向上
3. **より詳細な分析**: ユーザー属性別、時間帯別などの詳細な分析機能を追加
4. **エクスポート機能**: CSV/PDFでのレポートエクスポート機能
5. **グラフのカスタマイズ**: 表示形式の選択（折れ線/棒グラフ/円グラフ）

## サポート

問題が解決しない場合は、以下の情報を添えて報告してください：

1. データ診断の結果（コンソールログ）
2. エラーメッセージ（あれば）
3. 使用している期間設定（週/月/年）
4. ユーザーと店舗の設定状況

